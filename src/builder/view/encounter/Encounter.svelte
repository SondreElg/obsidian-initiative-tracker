<script lang="ts">
    import { ExtraButtonComponent, Modal, Notice, Setting } from "obsidian";

    import Creature from "./Creature.svelte";
    import { Creature as CreatureCreator } from "../../../utils/creature";

    import { encounter } from "../../stores/encounter";
    import { START_ENCOUNTER } from "src/utils";
    import { getContext } from "svelte";
    import { tracker } from "src/tracker/stores/tracker";
    import type { CreatureState } from "index";
    import { writable } from "svelte/store";

    const { players } = encounter;

    const plugin = getContext("plugin");
    let name = writable("Encounter");
    let tempName = writable("");
    let updatingName = writable(false);

    const setName = () => {
        $updatingName = false;
        $name = $tempName.length ? $tempName : $name;
        $tempName = "";
    };
    const cancelName = () => {
        $updatingName = false;
        $tempName = "";
    };

    let rollHP = plugin.data.rollHP;

    $: items = [...$encounter.entries()];

    let startIcon: ExtraButtonComponent;
    const start = (node: HTMLElement) => {
        startIcon = new ExtraButtonComponent(node)
            .setIcon(START_ENCOUNTER)
            .onClick(async () => {
                if (!plugin.view) {
                    await plugin.addTrackerView();
                }

                const view = plugin.view;
                const creatures: CreatureCreator[] = [];
                const transformedCreatures: CreatureState[] = [];
                for (const [srd, count] of items) {
                    const creature = CreatureCreator.from(srd);
                    const amount = Math.max(
                        isNaN(Number(count)) ? 1 : Number(count),
                        1
                    );
                    creatures.push(
                        ...[...Array(amount).keys()].map((v) =>
                            CreatureCreator.new(creature)
                        )
                    );
                }
                for (const creature of [
                    ...$players.map(
                        (p) =>
                            plugin.getPlayerByName(p.name) ??
                            CreatureCreator.from(p)
                    ),
                    ...creatures
                ]) {
                    transformedCreatures.push(creature.toJSON());
                }
                tracker.new(plugin, {
                    creatures: transformedCreatures,
                    name: $name,
                    round: 1,
                    state: false,
                    logFile: null,
                    roll: true,
                    rollHP
                });
                plugin.app.workspace.revealLeaf(view.leaf);
            });
    };

    $: {
        if (startIcon) {
            if (!items.length) {
                startIcon.setDisabled(true);
                startIcon.setTooltip("");
            } else {
                startIcon.setDisabled(false);
                startIcon.setTooltip("Start Encounter");
            }
        }
    }
    const editIcon = (node: HTMLElement) => {
        new ExtraButtonComponent(node).setIcon("pencil");
    };

    const saveIcon = (node: HTMLElement) => {
        new ExtraButtonComponent(node).setIcon("save");
    };
    const save = () => {
        const modal = new Modal(app);
        modal.contentEl.createEl("h4", { text: "Save Encounter" });
        let encName: string =
            $name != "Encounter"
                ? $name
                : `Encounter ${Object.keys(plugin.data.encounters).length}`;
        new Setting(modal.contentEl).setName("Encounter Name").addText((t) => {
            t.setPlaceholder(encName).onChange((v) => (encName = v));
        });
        new Setting(modal.contentEl).addButton((b) =>
            b.setButtonText("Save").onClick(() => {
                if (encName in plugin.data.encounters) {
                    new Notice("An encounter by that name already exists.");
                    return;
                }
                const creatures = [
                    ...[...$players].map((p) => CreatureCreator.from(p)),
                    ...[...$encounter.entries()]
                        .map((c) =>
                            [...Array(c[1]).keys()].map(() =>
                                CreatureCreator.from(c[0])
                            )
                        )
                        .flat()
                ];
                plugin.data.encounters[encName] = {
                    creatures: [...creatures.map((c) => c.toJSON())],
                    state: false,
                    name: encName,
                    round: 1,
                    logFile: null
                };
                modal.close();
            })
        );
        modal.open();
    };

    const cancelIcon = (node: HTMLElement) => {
        new ExtraButtonComponent(node).setIcon("cross-in-box");
    };
    let exportIcon: ExtraButtonComponent;
    const exp = (node: HTMLElement) => {
        exportIcon = new ExtraButtonComponent(node).setIcon("code");
    };
    $: {
        if (exportIcon) {
            if (!items.length) {
                exportIcon.setDisabled(true);
                exportIcon.setTooltip("");
            } else {
                exportIcon.setDisabled(false);
                exportIcon.setTooltip("Export Encounter to Note");
            }
        }
    }

    const load = (node: HTMLElement) => {
        new ExtraButtonComponent(node)
            .setIcon("import")
            .setTooltip("Load Encounter")
            .onClick(() => {});
    };
    const clear = (node: HTMLElement) => {
        new ExtraButtonComponent(node)
            .setIcon("eraser")
            .setTooltip("Clear Encounter");
    };
</script>

<div class="encounter-header">
    <div class="encounter-name">
        {#if $updatingName}
            <input type="text" bind:value={$tempName} placeholder={$name} />
            <div use:saveIcon on:click={setName} />
            <div use:cancelIcon on:click={cancelName} />
        {:else}
            <h5 class="built-encounter">{$name}</h5>
            <div use:editIcon on:click={() => ($updatingName = true)} />
        {/if}
    </div>
    <div class="encounter-controls">
        <div use:start />
        <div use:saveIcon on:click={save} />
        <!-- <div use:exp /> -->
        <!-- <div use:load /> -->

        <div
            use:clear
            on:click={() => {
                encounter.empty();
                $name = "Encounter";
            }}
        />
    </div>
</div>
{#if !items.length}
    <span>Add some creatures to get started!</span>
{:else}
    <div class="encounter-creatures">
        {#each items as [creature, count]}
            <Creature {creature} {count} />
        {/each}
    </div>
{/if}

<style scoped>
    .encounter-name {
        display: flex;
        align-items: center;
    }
    .encounter-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .encounter-creatures {
        display: flex;
        gap: 0.5rem;
        flex-flow: column nowrap;
    }
    .encounter-header :global(.is-disabled) {
        cursor: not-allowed;
    }
    .encounter-controls {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
</style>
